import{d as S,m as k,u as E,o as U,c as B,a6 as I,H as V,e as L,Y as T,c2 as O,c3 as $,E as c,r as M,w}from"./index-BiiIy8BH.js";import{g as j,h as F}from"./index.vue_vue_type_style_index_0_lang-B8Ks5WcW.js";import"./upload-BGO06KGh.js";import"./progress-CCLXG-1J.js";const R=S({name:"CommonUpload",__name:"index",props:k({fileLimit:{default:100},readonly:{type:Boolean},disabled:{type:Boolean},preview:{type:Boolean,default:!0},limit:{},multiple:{type:Boolean},drag:{type:Boolean,default:!0},category:{},accept:{default:""},itemStyle:{},buttonStyle:{},sortable:{type:[Boolean,Object],default:()=>({forceFallback:!0})},imageProps:{},progressProps:{},previewProps:{},tools:{type:Boolean,default:!0},listType:{},beforeUploadClick:{},beforeItemEdit:{},locale:{}},{modelValue:{type:Array,default:()=>[]},modelModifiers:{}}),emits:k(["itemClick","preview"],["update:modelValue"]),setup(f,{emit:y}){const p=f,a=y,n=E(f,"modelValue"),i=t=>{if(t){if(p.accept==="image/*"){if(!t.type.startsWith("image")){c.error("只能选择图片");return}}else if(p.accept===".xls,.xlsx"&&!["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(t.type)){c.error("只能选择 excel 文件");return}if(p.fileLimit&&t.size/1024/1024>p.fileLimit){c.error(`大小不能超过 ${p.fileLimit}MB`);return}return!0}},u=(t,e)=>{if(!t.file||!i(t.file))return;e||n.value.push({...t});const l=n.value.find(o=>o.key===t.key);l&&(l.status="uploading",l.progress=0,j(p.category,t.file,t.file.name,{onUploadProgress:o=>{o.total!=null&&l.status!=="done"&&(l.progress=o.loaded/o.total*100)}}).then(o=>{var r;console.log(o),l.progress=100,l.status="done",l.url=(r=o==null?void 0:o.data)==null?void 0:r.url}).catch(o=>{l.status="exception",c.error(o.message)}))},g=({item:t,newItem:e})=>{if(!i(e.file))return;const l=n.value.find(o=>o.key===t.key);l&&(l.url=void 0,l.name=e.name,l.file=e.file,l.progress=0,l.status=void 0,u(l,!0))},b=t=>{n.value.splice(n.value.indexOf(t),1)},v=t=>{a("itemClick",t)},h=t=>{a("preview",t)};return(t,e)=>{const l=F;return U(),B(l,{modelValue:n.value,"onUpdate:modelValue":e[0]||(e[0]=o=>n.value=o),readonly:t.readonly,disabled:t.disabled,preview:t.preview,limit:t.limit,multiple:t.multiple,drag:t.drag,accept:t.accept,itemStyle:t.itemStyle,buttonStyle:t.buttonStyle,sortable:t.sortable,imageProps:t.imageProps,progressProps:t.progressProps,previewProps:t.previewProps,tools:t.tools,listType:t.listType,beforeUploadClick:t.beforeUploadClick,beforeItemEdit:t.beforeItemEdit,locale:t.locale,onUpload:u,onRetry:e[1]||(e[1]=o=>u(o,!0)),onRemove:b,onEditUpload:g,onItemClick:v,onPreview:h},I({_:2},[V(Object.keys(t.$slots),o=>({name:o,fn:L(r=>[T(t.$slots,o,O($(r||{})))])}))]),1032,["modelValue","readonly","disabled","preview","limit","multiple","drag","accept","itemStyle","buttonStyle","sortable","imageProps","progressProps","previewProps","tools","listType","beforeUploadClick","beforeItemEdit","locale"])}}}),A=S({name:"ImageUpload",__name:"index",props:{modelValue:{default:""},fileLimit:{default:100},readonly:{type:Boolean},disabled:{type:Boolean},preview:{type:Boolean,default:!0},limit:{},multiple:{type:Boolean},category:{},drag:{type:Boolean,default:!0},accept:{default:"image/*"},itemStyle:{},buttonStyle:{},sortable:{type:[Boolean,Object],default:()=>({forceFallback:!0})},imageProps:{},progressProps:{},previewProps:{},tools:{type:Boolean,default:!0},listType:{},beforeUploadClick:{},beforeItemEdit:{},locale:{}},emits:["update:modelValue","change"],setup(f,{expose:y,emit:p}){const a=f,n=p,i=M([]),u=e=>{var r;const l=(r=a.modelValue)!=null?r:"",o=e!=null?e:"";l!==o&&(n("update:modelValue",o),n("change",e))},g=()=>{i.value=[]},b=()=>!i.value.some(e=>e.status!=="done"),v=e=>{const l=[];return e.forEach(o=>{o.status==="done"&&o.url!=null&&l.push(o.url)}),l},h=(e,l)=>{if(!e)return l.filter(r=>r.status!=="done");const o=[];if(a.limit===1)return o.push({key:`0-${e}`,url:e,status:"done"}),o;try{const r=JSON.parse(e);if(l.forEach(s=>{(s.url&&r.includes(s.url)||s.status!=="done")&&o.push(s)}),r.forEach((s,m)=>{if(s&&!o.some(d=>d.url===s)){const d=`${m}-${s}`,P=o.findIndex(C=>C.key===d);P!==-1&&o.splice(P,1),o.push({key:d,url:s,status:"done"})}}),a.limit!=null&&o.length>a.limit){const s=o.filter(m=>m.status!=="done");for(const m of s){const d=o.indexOf(m);if(o.splice(d,1),o.length<=a.limit)break}}}catch(r){console.error(r),l.forEach(s=>{s.status!=="done"&&o.push(s)})}return o},t=(e,l)=>{if(e.length!==l.length)return!0;for(let o=0;o<e.length;o++){const r=e[o],s=l[o];if(r.key!==s.key||r.url!==s.url||r.status!==s.status)return!0}return!1};return w(i,e=>{const l=v(e);if(a.limit===1){u(l.join());return}u(l.length?JSON.stringify(l):"")},{deep:!0}),w(()=>a.modelValue,e=>{const l=h(e,i.value);t(l,i.value)&&(i.value=l)},{immediate:!0}),y({clearData:g,isDone:b}),(e,l)=>(U(),B(R,{modelValue:i.value,"onUpdate:modelValue":l[0]||(l[0]=o=>i.value=o),fileLimit:e.fileLimit,readonly:e.readonly,disabled:e.disabled,category:e.category,preview:e.preview,limit:e.limit,multiple:e.multiple,drag:e.drag,accept:e.accept,itemStyle:e.itemStyle,buttonStyle:e.buttonStyle,sortable:e.sortable,imageProps:e.imageProps,progressProps:e.progressProps,previewProps:e.previewProps,tools:e.tools,listType:e.listType,beforeUploadClick:e.beforeUploadClick,beforeItemEdit:e.beforeItemEdit,locale:e.locale},null,8,["modelValue","fileLimit","readonly","disabled","category","preview","limit","multiple","drag","accept","itemStyle","buttonStyle","sortable","imageProps","progressProps","previewProps","tools","listType","beforeUploadClick","beforeItemEdit","locale"]))}});export{A as _};
